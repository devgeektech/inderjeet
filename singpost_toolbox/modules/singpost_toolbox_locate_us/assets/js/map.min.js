jQuery(function($){var map;var originPlaceId="";var travelMode=google.maps.TravelMode.DRIVING;var directionsService=new google.maps.DirectionsService;var directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true});var pinA;var destinationLat;var destinationLng;var isDefaultOrigin=false;function initMapData(){initMap();var loc_id=getParameterByName("id");jQuery.ajax({type:"POST",url:"/locate-us/get-map-data","async":true,dataType:"json",data:{id:loc_id}}).done(function(json){initMap(json);jQuery("#map").removeClass("loading")})}function initMap(json){if(typeof google=="undefined"){return}if(typeof jQuery=="undefined"){return}var geocoder=new google.maps.Geocoder;map=new google.maps.Map(document.getElementById("map"),{maxZoom:17});CaculateRoute(map);google.maps.event.addDomListener(document.getElementById("go"),"click",function(){if(jQuery("#origin-input").val()){if(typeof route()==="function"){showRoute(true,true)}}else{$("#panel-error").text("Please enter your starting location");$("#panel-error").show()}});google.maps.event.addDomListener(document.getElementById("back"),"click",function(){showRoute(false,true)});$(".btn-close-form").on("click",function(){jQuery("#locate-us .list-location").slideDown();jQuery("#locate-us .right-info").slideUp()});if(!jQuery.isEmptyObject(json)){if(json.data_map!=null&&json.data_map.length>0){var features=[];json.data_map.forEach(function(feature){if(feature.houseBlockNumber===null){feature.houseBlockNumber=""}if(feature.postCode===null){feature.postCode=""}if(feature.streetName===null){feature.streetName=""}var full_address=feature.houseBlockNumber+" "+feature.streetName;var custom_address=feature.houseBlockNumber+" "+feature.streetName+", Singapore "+feature.postCode;if(feature.unitNumber!==null||feature.buildingName!==null){if(feature.unitNumber===null){feature.unitNumber=""}if(feature.buildingName===null){feature.buildingName=""}full_address=full_address+", "+feature.unitNumber+" "+feature.buildingName}full_address=full_address+", Singapore "+feature.postCode;features.push({position:new google.maps.LatLng(feature.latitude,feature.longitude),type:feature.outletType,marker_id:feature.outletId,title:feature.buildingName,outlet_name:feature.outletName,service:feature.service,open_hours:feature.operatingHours,address:full_address,custom_adrress:custom_address})});var bounds=new google.maps.LatLngBounds;var allMarkers=[];features.forEach(function(feature){var marker=new google.maps.Marker({position:feature.position,type_id:feature.type,map:map,title:feature.outlet_name,icon:json.marker,marker_id:feature.marker_id,address:feature.address,custom_adrress:feature.custom_adrress});allMarkers.push(marker);google.maps.event.addListener(marker,"click",function(marker,i){var html=renderLayout(feature);jQuery("#locate-us .locate-content-container").html(html);jQuery("#locate-us .heading-title").text(feature.outlet_name);jQuery("#locate-us .type-location").text(splitCapitalCharacter(feature.type));jQuery("#locate-us .address-location").text(feature.address);jQuery("#locate-us .locate-content-container").html(html);jQuery("#locate-us .list-location").slideUp();jQuery("#locate-us .right-info").slideDown();originPlaceId=jQuery("#place-id-node").val();isDefaultOrigin=true;showRoute(false,true);if(json.data_map.length>1){for(var i=0;i<allMarkers.length;i++){if(allMarkers[i].marker_id!=this.marker_id){allMarkers[i].setAnimation(null)}}this.setAnimation(google.maps.Animation.BOUNCE);destinationLat=this.getPosition().lat();destinationLng=this.getPosition().lng();jQuery("#destination-input").val(this.custom_adrress);map.setZoom(17)}map.setCenter(this.position)});jQuery(".title-marker").on("click",function(){google.maps.event.trigger(allMarkers[jQuery(this).attr("data-markerid")],"click")});bounds.extend(feature.position);if(json.data_map.length==1){new google.maps.event.trigger(marker,"click")}});if(json.url){google.maps.event.trigger(allMarkers[0],"click")}map.fitBounds(bounds)}var bounds=new google.maps.LatLngBounds;if(json.place_id!==null){defaultOriginPlaceId=json.place_id;var service=new google.maps.places.PlacesService(map);service.getDetails({placeId:json.place_id},function(result,status){var marker=new google.maps.Marker({map:map,position:result.geometry.location,place:{placeId:json.place_id,location:result.geometry.location}});bounds.extend(marker.position);var closest=findClosestLocation(allMarkers,marker);setBoundClosestLocation(bounds,closest,map)})}else{if(json.keyword!==null){var request={query:json.keyword,fields:["name","geometry","place_id"]};var service=new google.maps.places.PlacesService(map);service.findPlaceFromQuery(request,(results,status)=>{if(status===google.maps.places.PlacesServiceStatus.OK&&results){if(results!==null&&results.length>0){if(!results[0].geometry||!results[0].geometry.location){return}var marker=new google.maps.Marker({map:map,position:results[0].geometry.location,place:{placeId:results[0].place_id,location:results[0].geometry.location}});jQuery("#place-id-node").val(results[0].place_id);originPlaceId=jQuery("#place-id-node").val();bounds.extend(marker.position);var closest=findClosestLocation(allMarkers,marker);setBoundClosestLocation(bounds,closest,map)}}else{geocoder.geocode({address:json.keyword+", Singapore"},function(results,status){if(status==="OK"){var marker=new google.maps.Marker({position:results[0].geometry.keyword,map:map});bounds.extend(marker.position);var closest=findClosestLocation(allMarkers,marker);setBoundClosestLocation(bounds,closest,map)}})}})}}}else{geocoder.geocode({address:"Singapore"},function(results,status){if(status==google.maps.GeocoderStatus.OK){map.setCenter(results[0].geometry.location)}})}}function setBoundClosestLocation(bounds,closest_locations,map){if(closest_locations.length){for(i=0;i<3;i++){if(closest_locations[i]!==undefined){bounds.extend(closest_locations[i].location.position)}}map.fitBounds(bounds)}}function findClosestLocation(locationMarkers,currentMarker){var closest=[];locationMarkers.forEach(function(location){closest.push({distance:google.maps.geometry.spherical.computeDistanceBetween(location.position,currentMarker.position),location:location})});closest.sort(function(a,b){return a.distance-b.distance});return closest}function initAutocomplete(){var input=document.getElementsByClassName("map-autocomplete");var options={componentRestrictions:{country:"sg"}};for(var i=0;i<input.length;i++){var autocomplete=new google.maps.places.Autocomplete(input[i],options);autocomplete.targetID=input[i].getAttribute("target-id");autocomplete.addListener("place_changed",function(){var place=this.getPlace();if(!place.geometry){return}var placeId=place.place_id;document.getElementById(this.targetID).value=placeId})}}function renderLayout(location){var html="";html+='<div class="locate-content-infobox accordion mt-4" id="accordion-data">';if(location.open_hours){html+='<h2 class="mb-0" id="heading-open-hours">\n'+'        <button class="btn btn-block btn-accordion btn-open-hours" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">\n'+"          Opening Hours\n"+"        </button>\n"+"    </h2>\n"+'    <ul id="collapseOne" class="collapse show" aria-labelledby="heading-open-hours" data-parent="#accordion-data">\n'+"        "+formatDataHours(location.open_hours)+"\n"+'    </ul><hr style="margin: 0 1rem">'}if(location.service){html+='<h2 class="mb-0" id="heading-service">\n'+'        <button class="btn btn-block btn-accordion" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">\n'+"          Service\n"+"        </button>\n"+"    </h2>\n"+'    <ul id="collapseTwo" class="collapse" aria-labelledby="heading-service" data-parent="#accordion-data">\n'+"        "+formatDataService(location.service)+"\n"+"    </ul>"}html+="</div>";return html}function getParameterByName(name,url){if(!url){url=window.location.href}name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);if(!results){return null}if(!results[2]){return""}return decodeURIComponent(results[2].replace(/\+/g," "))}function CaculateRoute(map){directionsRenderer.setMap(map);const originInput=document.getElementById("origin-input");var originAutocomplete=new google.maps.places.Autocomplete(originInput);originAutocomplete.setFields(["place_id"]);setupClickListener("changemode-driving",google.maps.TravelMode.DRIVING);setupClickListener("changemode-walking",google.maps.TravelMode.WALKING);setupClickListener("changemode-transit",google.maps.TravelMode.TRANSIT);setupClickListener("changemode-bicycling",google.maps.TravelMode.BICYCLING);setupPlaceChangedListener(originAutocomplete,"ORIG")}function setupClickListener(id,mode){const radioButton=document.getElementById(id);radioButton.addEventListener("click",()=>{travelMode=mode;showRoute(true);route()})}function setupPlaceChangedListener(autocomplete,mode){autocomplete.addListener("place_changed",()=>{const place=autocomplete.getPlace();isDefaultOrigin=false;if(!place.place_id){window.alert("Please select an option from the dropdown list.");return}if(mode==="ORIG"){originPlaceId=place.place_id}})}function route(){if(!originPlaceId){return}var latlngDestination={lat:parseFloat(destinationLat),lng:parseFloat(destinationLng)};var panelError=jQuery("#panel-error");var panel=document.getElementById("panel");directionsService.route({origin:{placeId:originPlaceId},destination:latlngDestination,travelMode:travelMode},(response,status)=>{if(status==="OK"){clearMarker();directionsRenderer.setDirections(response);var _route=response.routes[0].legs[0];if(isDefaultOrigin===false){pinA=new google.maps.Marker({position:_route.start_location,map:map})}directionsRenderer.setPanel(panel);showRoute(true)}else if(status==="ZERO_RESULTS"){panelError.text("Directions for "+travelMode.toLowerCase()+" is not available");showRoute(false)}else if(status==="NOT_FOUND"){panelError.text("There are no locations found!");showRoute(false)}else{window.alert("Directions request failed due to "+status)}})}function clearMarker(){if(pinA){pinA.setMap(null)}}function showRoute(isShow,isClose){if(isShow===false){$("#panel").hide();$("#panel-error").show();directionsRenderer.setMap(null)}else{$("#panel").show();$("#mode-selector").show();$("#back").show();$("#panel-error").hide();$(".locate-content-container").hide();directionsRenderer.setMap(map)}if(isClose){$(".locate-content-container").show();$("#mode-selector").hide();$("#back").hide();$("#panel-error").hide();directionsRenderer.setMap(null);resetTravelModeSelection()}}function formatDataHours(str){if(str.toLowerCase()==="24hrs"){return str}if(str){var arr=str.split(" ");var new_arr=[];var i=0;var html="";arr.forEach(function(item,index){if(index<8){if(arr[i]==="undefined"){return false}new_arr.push(arr[i]+" "+arr[i+1]);i=i+1;i++}});if(new_arr){$.each(new_arr,function(item){if(item!=new_arr.length-1){html+="<li>"+new_arr[item]+"</li>"}})}return html}}function formatDataService(str){var html="";var arr=str.split(",");if(arr.length>1){$.each(arr,function(item){if(item!=arr.length-1){html+="<li>"+arr[item]+"</li>"}})}else{html=str}return html}function isUpper(str){return!/[a-z]/.test(str)&&/[A-Z]/.test(str)}function splitCapitalCharacter(data){var result=data[0];for(i=1;i<data.length;i++){var char=data[i];var prechar=data[i-1];if(!isUpper(prechar)&&isUpper(char)){result+=" "+char}else{result+=char}}return result}function resetTravelModeSelection(){travelMode=google.maps.TravelMode.DRIVING;$("#mode-selector input[type=radio]").prop("checked",false);$("#mode-selector #changemode-driving").prop("checked",true)}jQuery(document).ready(function($){initAutocomplete();if(document.getElementById("map")!==null){initMapData()}$(".map-autocomplete").each(function(){var targetID=$(this).attr("target-id");$(this).on("change",function(){$("#"+targetID).val("")})})})});